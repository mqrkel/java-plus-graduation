# Фича «Локации»

## Структура локации

**Поля**

- `id` — уникальный идентификатор локации (целое число).
- `creator` — пользователь, создавший локацию.
- `name` — название локации, строка.
- `address` — физический адрес локации (опционально), строка.
- `latitude` — широта (обязательное поле, диапазон: [-90, 90]).
- `longitude` — долгота (обязательное поле, диапазон: [-180, 180]).
- `state` — статус локации: `PENDING`, `APPROVED`, `REJECTED`, `AUTO_GENERATED`.  
  По умолчанию — `PENDING`.

### Статусы локаций

- `PENDING` — статус локаций, созданных пользователями, до момента одобрения администратором.  
  Локации с этим статусом:
    - нельзя привязывать к событиям;
    - они не видны другим пользователям при поиске.

- `APPROVED` — статус локаций, созданных или одобренных администратором.  
  Локации с этим статусом:
    - можно привязывать к событиям;
    - они видны другим пользователям при поиске.

- `REJECTED` — локации, отклонённые администратором.  
  Локации с этим статусом:
    - нельзя привязывать к событиям;
    - они не видны другим пользователям при поиске.

- `AUTO_GENERATED` — «безымянные» локации, не имеющие создателя, имени и адреса, а только координаты.  
  Такие локации используются для автоматической привязки событий по координатам.

Изменять статус локации может только администратор.  
Администратор **не может** переводить локацию в статусы `PENDING` или `AUTO_GENERATED` из любого другого состояния.

---

## Создание локации

### Создание администратором

- Локация создаётся сразу со статусом `APPROVED`.
- Поле `creator` при этом равно `null`.

### Создание пользователем

При попытке создать локацию:

1. Система проверяет наличие существующей локации **с тем же именем** и **в тех же координатах** (радиус поиска — 50 м).
2. Если такая локация найдена — возвращается ошибка `409 CONFLICT` и `id` существующей локации.
3. При успешном создании пользовательская локация получает статус `PENDING`.

### Автоматическое создание локации

При создании события с указанием координат, но **без** указания `id` локации:

1. Система ищет существующую `AUTO_GENERATED` локацию в данных координатах (радиус поиска — 20 м).
2. Если локация найдена — она привязывается к событию.
3. Если не найдена — создаётся новая `AUTO_GENERATED` локация с указанными координатами и привязывается к событию.

> **Почему поиск идёт только среди `AUTO_GENERATED` локаций, а не `APPROVED`?**  
> Чтобы избежать автоматической привязки к локации, которая географически находится в том же месте,
> но не имеет отношения к конкретному событию (например, студия йоги и кружок детского творчества могут находиться в
> одном здании, но должны быть разными локациями в системе).

---

## Редактирование локации

### Редактирование администратором

Администратор может редактировать **все поля** всех локаций, включая статус.

### Редактирование пользователем

Пользователь может редактировать **только свои** локации **в статусе `PENDING`**.  
Одобренные (`APPROVED`) и отклонённые (`REJECTED`) локации пользователю недоступны для изменения.

---

## Поиск и просмотр локаций

### Поиск для администратора

Администратор может искать среди **всех** локаций, с фильтрацией по:

- совпадению в тексте названия или адреса;
- `creatorId` (для поиска локаций без информации о создателе используется `creatorId=0`);
- статусу;
- координатам (с указанием радиуса поиска);
- количеству связанных событий (диапазон), что позволяет находить «мертвые» локации и удалять их.

Администратор видит все поля всех локаций.

### Поиск для авторизованного пользователя

Пользователь может искать **свои** локации с фильтрацией по:

- статусу;
- совпадению в тексте названия или адреса;
- координатам (с указанием радиуса поиска).

При просмотре пользователь **не видит** поле `creator` у чужих локаций.

### Публичный поиск одобренных локаций

Доступен поиск среди локаций в статусе `APPROVED` с фильтрацией по:

- совпадению в тексте названия или адреса;
- координатам (с указанием радиуса поиска).

Публичный поиск позволяет пользователю найти уже существующую локацию и создать событие, привязав его к ней.

---

## Поиск событий по локациям и координатам

Публичный поиск событий поддерживает два варианта:

- поиск по `id` локации;
- поиск по координатам с заданным радиусом.

Это позволяет, например, найти все события в определённом месте или рядом с ним.

---

## Удаление локаций

Удаление локаций возможно:

- администратором;
- создателем локации.

Ограничения:

- нельзя удалять локации, к которым уже привязаны события.

---

## Архитектура и взаимодействие сервисов

Проект переведён на микросервисную архитектуру. Основные сервисы:

- `category-service` — управление категориями событий;
- `user-service` — управление пользователями;
- `event-service` — управление событиями;
- `request-service` — управление заявками на участие;
- `location-service` — управление локациями (описанная выше функциональность);
- `stats-server` (+ `stats-client`, `stats-dto`) — сбор и предоставление статистики;
- `gateway-server` — единая точка входа для внешних клиентов (порт `8080`);
- `config-server` — централизованная конфигурация;
- `discovery-server` — Eureka, сервис-дискавери.

### Внутренний API

Примеры взаимодействия:

- `event-service → location-service` — определение / автоматическое создание локации по координатам:
    - `POST /locations/auto` — создать или вернуть существующую `AUTO_GENERATED` локацию по координатам;
- большинство запросов из Postman выполняются через `gateway-server` на `http://localhost:8080`, а сами сервисы находят
- друг друга через Eureka и Feign-клиенты.

---

## Запуск и тестирование

### Запуск инфраструктуры

Для локального запуска используется Docker Compose:

- Postgres;
- сервисы инфраструктуры (`discovery-server`, `config-server`, `gateway-server`).
